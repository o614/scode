<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®¿é—®å—é™</title>
  <style>
    /* ğŸ¨ å®šä¹‰é¢œè‰²å˜é‡ï¼šé»˜è®¤æµ…è‰²æ¨¡å¼ (Light Mode) */
    :root {
      --bg-color: #f2f2f7;           /* æµ…ç°èƒŒæ™¯ */
      --card-bg: #ffffff;            /* ç™½è‰²å¡ç‰‡ */
      --text-main: #1c1c1e;          /* æ·±é»‘æ–‡å­— */
      --text-sub: #8e8e93;           /* ç°è‰²å‰¯æ ‡é¢˜ */
      --border-color: rgba(0,0,0,0.1);
      --code-bg: rgba(0,0,0,0.05);   /* éªŒè¯ç èƒŒæ™¯ */
      --shadow: 0 10px 25px rgba(0,0,0,0.1);
      --accent-color: #007aff;       /* iOS è“ */
    }

    /* ğŸŒ‘ æ·±è‰²æ¨¡å¼é€‚é… (Dark Mode) - å½“ç³»ç»Ÿè®¾ç½®ä¸ºæ·±è‰²æ—¶è‡ªåŠ¨è¦†ç›–å˜é‡ */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #000000;         /* çº¯é»‘èƒŒæ™¯ */
        --card-bg: #1c1c1e;          /* æ·±ç°å¡ç‰‡ */
        --text-main: #f5f5f7;        /* æµ…ç™½æ–‡å­— */
        --text-sub: #98989d;
        --border-color: rgba(255,255,255,0.15);
        --code-bg: rgba(255,255,255,0.1);
        --shadow: 0 20px 40px rgba(0,0,0,0.4);
        --accent-color: #0a84ff;
      }
    }

    /* é€šç”¨æ ·å¼ */
    body {
      margin: 0; 
      padding: 0; 
      background: var(--bg-color); 
      color: var(--text-main); 
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; 
      height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      transition: background 0.3s ease, color 0.3s ease;
    }
    
    .container { 
      width: 100%; 
      max-width: 380px; 
      padding: 20px; 
      box-sizing: border-box;
    }
    
    .lock-card { 
      background: var(--card-bg); 
      border-radius: 24px; 
      padding: 40px 24px; 
      box-shadow: var(--shadow); 
      border: 1px solid var(--border-color); 
      text-align: center;
      transition: background 0.3s ease, border 0.3s ease, box-shadow 0.3s ease;
    }
    
    .hidden { display: none !important; }
    
    /* å›¾æ ‡ä¸æ–‡å­— */
    .icon-wrapper {
      width: 64px;
      height: 64px;
      background: var(--code-bg);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px auto;
      font-size: 32px;
    }

    h1 { 
      font-size: 22px; 
      margin: 0 0 8px 0; 
      font-weight: 700; 
    }
    
    p { 
      font-size: 15px; 
      color: var(--text-sub); 
      margin: 0 0 30px 0; 
      line-height: 1.5; 
    }
    
    /* äºŒç»´ç å›¾ç‰‡å®¹å™¨ - å§‹ç»ˆä¿æŒç™½è‰²èƒŒæ™¯ä»¥ä¾¿æ‰«æ */
    .qr-box { 
      width: 180px; 
      height: 180px; 
      background: #ffffff; 
      padding: 10px; 
      border-radius: 16px; 
      margin: 0 auto 30px auto; 
      border: 1px solid rgba(0,0,0,0.1);
    }
    .qr-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }

    /* éªŒè¯ç æ˜¾ç¤ºåŒº */
    .code-display { 
      background: var(--code-bg); 
      border-radius: 16px; 
      padding: 15px; 
      position: relative; 
      margin-bottom: 20px;
    }
    
    .code-number { 
      font-family: "SF Mono", "Menlo", monospace; 
      font-size: 36px; 
      letter-spacing: 6px; 
      font-weight: 700; 
      color: var(--text-main); 
      display: block; 
    }
    
    .timer { 
      position: absolute; 
      top: 8px; 
      right: 12px; 
      font-size: 11px; 
      color: var(--text-sub); 
      font-weight: 600;
      background: var(--card-bg);
      padding: 2px 6px;
      border-radius: 6px;
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .spinner { 
      display: inline-block; 
      width: 18px; 
      height: 18px; 
      border: 2px solid var(--text-sub); 
      border-radius: 50%; 
      border-top-color: transparent; 
      animation: spin 1s linear infinite; 
      vertical-align: middle; 
      margin-right: 6px; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .status-text { font-size: 13px; color: var(--text-sub); }
  </style>
</head>
<body>

  <div id="lockPage" class="container">
    <div class="lock-card">
      <div class="icon-wrapper">ğŸ”’</div>
      <h1>è®¿é—®å—é™</h1>
      <p>ä¸ºäº†é˜²æ­¢æ»¥ç”¨ï¼Œè¯·æ‰«ç è·å–éªŒè¯ç <br>éªŒè¯é€šè¿‡åè‡ªåŠ¨è·³è½¬</p>
      
      <div class="qr-box">
        <img src="https://www.haiyan.gov.cn/picture/-1/240308141912543626.png" alt="Scan QR Code">
      </div>

      <div class="code-display">
        <div id="timer" class="timer">60s</div>
        <span id="code" class="code-number">....</span>
      </div>
      
      <div class="status-text">
        <span class="spinner"></span> æ­£åœ¨ç­‰å¾…éªŒè¯...
      </div>
    </div>
  </div>

  <div id="unlockPage" class="container hidden">
    <div class="lock-card">
      <div class="icon-wrapper" style="color: #34c759; background: rgba(52, 199, 89, 0.1);">ğŸ”“</div>
      <h1>éªŒè¯æˆåŠŸ</h1>
      <p>é¡µé¢å³å°†è·³è½¬ï¼Œè¯·ç¨å€™...</p>
      <div class="spinner" style="border-color: #34c759; border-top-color: transparent;"></div>
    </div>
  </div>

  <script>
    // ================= é…ç½®åŒºåŸŸ =================
    const API_BASE = '/api/web';  
    const TARGET_URL = 'https://www.google.com'; // ğŸ”“ è§£é”åè·³è½¬çš„ç›®æ ‡ç½‘å€ (è¯·ä¿®æ”¹è¿™é‡Œ)
    // ===========================================

    let timerInterval, pollInterval;

    (function init() {
      if (checkCachedToken()) {
        unlockAndRedirect();
      } else {
        startLockFlow();
      }
    })();

    function startLockFlow() {
      const code = Math.floor(Math.random() * 9000) + 1000;
      document.getElementById('code').innerText = code;
      fetch(`${API_BASE}?type=init&code=${code}`).catch(console.error);

      let timeLeft = 60;
      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').innerText = timeLeft + 's';
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          clearInterval(pollInterval);
          alert('éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°é¡µé¢');
          location.reload();
        }
      }, 1000);

      pollInterval = setInterval(async () => {
        try {
          const res = await fetch(`${API_BASE}?type=check&code=${code}`);
          const json = await res.json();
          if (json.status === 'success') {
            handleSuccess(json.token);
          }
        } catch(e) {}
      }, 3000);
    }

    function handleSuccess(token) {
      clearInterval(timerInterval);
      clearInterval(pollInterval);
      localStorage.setItem('unlock_token', token);
      localStorage.setItem('token_time', Date.now());
      document.getElementById('lockPage').classList.add('hidden');
      document.getElementById('unlockPage').classList.remove('hidden');
      setTimeout(() => { window.location.href = TARGET_URL; }, 1500);
    }

    function checkCachedToken() {
      const token = localStorage.getItem('unlock_token');
      const time = localStorage.getItem('token_time');
      return (token && time && (Date.now() - time < 604800000));
    }

    function unlockAndRedirect() {
      document.getElementById('lockPage').classList.add('hidden');
      window.location.href = TARGET_URL;
    }
  </script>
</body>
</html>
