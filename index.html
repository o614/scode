<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®¿é—®å—é™</title>
  <style>
    /* ğŸ¨ é¢œè‰²å˜é‡ (ä¿æŒæ·±è‰²æ¨¡å¼é€‚é…) */
    :root {
      --bg-color: #f2f2f7;
      --card-bg: #ffffff;
      --text-main: #1c1c1e;
      --text-sub: #8e8e93;
      --border-color: rgba(0,0,0,0.1);
      --code-bg: rgba(0,0,0,0.05);
      --shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #000000;
        --card-bg: #1c1c1e;
        --text-main: #f5f5f7;
        --text-sub: #98989d;
        --border-color: rgba(255,255,255,0.15);
        --code-bg: rgba(255,255,255,0.1);
        --shadow: 0 20px 40px rgba(0,0,0,0.4);
      }
    }

    body {
      margin: 0; padding: 0;
      background: var(--bg-color); color: var(--text-main);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      height: 100vh;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.3s ease;
    }
    
    .container { width: 100%; max-width: 340px; padding: 16px; box-sizing: border-box; }
    
    .lock-card { 
      background: var(--card-bg); 
      border-radius: 20px; /* åœ†è§’ç¨å¾®æ”¹å°ä¸€ç‚¹ç‚¹é€‚åº”ç´§å‡‘æ„Ÿ */
      padding: 24px 20px;  /* ğŸ“‰ å¤§å¹…å‡å°‘å†…è¾¹è· */
      box-shadow: var(--shadow); 
      border: 1px solid var(--border-color); 
      text-align: center;
    }
    
    .hidden { display: none !important; }
    
    h1 { 
      font-size: 20px; /* å­—å·å¾®è°ƒ */
      margin: 0 0 6px 0; 
      font-weight: 700; 
    }
    
    p { 
      font-size: 14px; 
      color: var(--text-sub); 
      margin: 0 0 20px 0; /* ğŸ“‰ å‡å°‘æ ‡é¢˜å’ŒäºŒç»´ç çš„é—´è· */
      line-height: 1.4; 
    }
    
    /* äºŒç»´ç å®¹å™¨ */
    .qr-box { 
      width: 160px; /* ç¨å¾®ç¼©å°ä¸€ç‚¹äºŒç»´ç åŒºåŸŸ */
      height: 160px; 
      background: #ffffff; 
      padding: 8px; /* å‡å°‘ç™½è¾¹ */
      border-radius: 12px; 
      margin: 0 auto 20px auto; /* ğŸ“‰ å‡å°‘åº•éƒ¨é—´è· */
      border: 1px solid rgba(0,0,0,0.1);
    }
    .qr-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }

    /* éªŒè¯ç æ˜¾ç¤ºåŒº */
    .code-display { 
      background: var(--code-bg); 
      border-radius: 12px; 
      padding: 12px 10px; /* ğŸ“‰ å‡å°‘å†…è¾¹è· */
      position: relative; 
      margin-bottom: 16px;
    }
    
    .code-number { 
      font-family: "Inter", -apple-system, sans-serif;
      font-size: 36px; /* å­—ä½“ç¨å¾®æ”¹å°ï¼Œæ›´ç²¾è‡´ */
      letter-spacing: 6px; 
      font-weight: 800; 
      color: var(--text-main); 
      display: block; 
      line-height: 1;
    }
    
    .timer { 
      position: absolute; top: 6px; right: 8px; 
      font-size: 10px; color: var(--text-sub); font-weight: 600;
      background: var(--card-bg); padding: 2px 5px; border-radius: 4px;
    }
    
    /* çŠ¶æ€æ–‡å­—å’ŒåŠ è½½åœˆ */
    .status-text { font-size: 12px; color: var(--text-sub); display: flex; align-items: center; justify-content: center; }
    
    .spinner { 
      width: 14px; height: 14px; /* ç¼©å°åŠ è½½åœˆ */
      border: 2px solid var(--text-sub); 
      border-radius: 50%; border-top-color: transparent; 
      animation: spin 1s linear infinite; margin-right: 6px; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="lockPage" class="container">
    <div class="lock-card">
      <h1>è®¿é—®å—é™</h1>
      <p>è¯·æ‰«ç å…³æ³¨å…¬ä¼—å·è·å–éªŒè¯ç <br>éªŒè¯é€šè¿‡åè‡ªåŠ¨è·³è½¬</p>
      
      <div class="qr-box">
        <img src="https://img14.360buyimg.com/ling/jfs/t1/357137/38/17178/6526/6926bbc1F2518fce2/9326a50442957ff5.jpg" alt="Scan QR Code">
      </div>

      <div class="code-display">
        <div id="timer" class="timer">60s</div>
        <span id="code" class="code-number">....</span>
      </div>
      
      <div class="status-text">
        <span class="spinner"></span> æ­£åœ¨ç­‰å¾…éªŒè¯...
      </div>
    </div>
  </div>

  <div id="unlockPage" class="container hidden">
    <div class="lock-card">
      <h1 style="color: #34c759; margin-bottom: 10px;">éªŒè¯æˆåŠŸ</h1>
      <p style="margin-bottom: 0;">é¡µé¢å³å°†è·³è½¬...</p>
      <div style="height: 20px;"></div> <div class="status-text">
        <div class="spinner" style="border-color: #34c759; border-top-color: transparent;"></div> è·³è½¬ä¸­
      </div>
    </div>
  </div>

  <script>
    // ================= é…ç½®åŒºåŸŸ =================
    const API_BASE = '/api/web';  
    const TARGET_URL = 'https://example.com/'; // ğŸ”“ è§£é”åè·³è½¬çš„ç›®æ ‡ç½‘å€
    // ===========================================

    let timerInterval, pollInterval;

    (function init() {
      if (checkCachedToken()) {
        unlockAndRedirect();
      } else {
        startLockFlow();
      }
    })();

    function startLockFlow() {
      const code = Math.floor(Math.random() * 9000) + 1000;
      document.getElementById('code').innerText = code;
      fetch(`${API_BASE}?type=init&code=${code}`).catch(console.error);

      let timeLeft = 60;
      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').innerText = timeLeft + 's';
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          clearInterval(pollInterval);
          alert('éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°é¡µé¢');
          location.reload();
        }
      }, 1000);

      pollInterval = setInterval(async () => {
        try {
          const res = await fetch(`${API_BASE}?type=check&code=${code}`);
          const json = await res.json();
          if (json.status === 'success') {
            handleSuccess(json.token);
          }
        } catch(e) {}
      }, 3000);
    }

    function handleSuccess(token) {
      clearInterval(timerInterval);
      clearInterval(pollInterval);
      localStorage.setItem('unlock_token', token);
      localStorage.setItem('token_time', Date.now());
      document.getElementById('lockPage').classList.add('hidden');
      document.getElementById('unlockPage').classList.remove('hidden');
      setTimeout(() => { window.location.href = TARGET_URL; }, 1500);
    }

    function checkCachedToken() {
      const token = localStorage.getItem('unlock_token');
      const time = localStorage.getItem('token_time');
      return (token && time && (Date.now() - time < 604800000));
    }

    function unlockAndRedirect() {
      document.getElementById('lockPage').classList.add('hidden');
      window.location.href = TARGET_URL;
    }
  </script>
</body>
</html>
