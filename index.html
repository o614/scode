<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Security Check</title>
  <style>
    /* ğŸ iOS System Colors & Variables */
    :root {
      /* Light Mode Defaults */
      --bg-color: #F2F2F7;           /* iOS System Grouped Background */
      --card-bg: #FFFFFF;            /* iOS System Background */
      --text-primary: #000000;       /* Label Color */
      --text-secondary: #8E8E93;     /* Secondary Label Color */
      --box-bg: #F3F4F6;             /* Fill Color */
      --accent: #007AFF;             /* iOS Blue */
      --border: rgba(0, 0, 0, 0.05); /* Subtle separator */
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08); /* Soft shadow */
    }

    /* ğŸŒ‘ Dark Mode Overrides (True Black) */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #000000;         /* True Black Background */
        --card-bg: #1C1C1E;          /* iOS Secondary System Background */
        --text-primary: #FFFFFF;
        --text-secondary: #98989D;
        --box-bg: #2C2C2E;           /* Tertiary System Fill */
        --accent: #0A84FF;           /* iOS Dark Mode Blue */
        --border: rgba(255, 255, 255, 0.1);
        --shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
      }
    }

    body {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      background-color: var(--bg-color);
      color: var(--text-primary);
      height: 100vh;
      display: flex; align-items: center; justify-content: center;
      transition: background-color 0.3s ease;
      -webkit-font-smoothing: antialiased; /* è®©å­—ä½“æ›´æ¸…æ™° */
    }

    .container { width: 100%; max-width: 360px; padding: 20px; box-sizing: border-box; }

    /* å¡ç‰‡è®¾è®¡ï¼šå…‹åˆ¶ã€å¹²å‡€ */
    .ios-card {
      background: var(--card-bg);
      border-radius: 20px; /* iOS é£æ ¼åœ†è§’ */
      padding: 32px 24px;
      text-align: center;
      box-shadow: var(--shadow);
      /* åªæœ‰æ·±è‰²æ¨¡å¼æ‰æ˜¾ç¤ºå¾®å¼±è¾¹æ¡†ï¼Œå¢åŠ å±‚æ¬¡ */
      border: 0.5px solid transparent; 
    }

    /* æ·±è‰²æ¨¡å¼ä¸‹ç»™å¡ç‰‡åŠ ä¸€ç‚¹ç‚¹è¾¹æ¡†ï¼Œé˜²æ­¢å’Œçº¯é»‘èƒŒæ™¯èä¸ºä¸€ä½“ */
    @media (prefers-color-scheme: dark) {
      .ios-card { border-color: var(--border); }
    }

    .hidden { display: none !important; }

    /* æ’ç‰ˆ */
    h1 {
      font-size: 24px;
      font-weight: 700; /* iOS Bold */
      margin: 0 0 8px 0;
      letter-spacing: -0.02em; /* iOS æ ‡é¢˜ç´§å‡‘æ„Ÿ */
    }

    p {
      font-size: 15px;
      color: var(--text-secondary);
      margin: 0 0 28px 0;
      line-height: 1.4;
      font-weight: 400;
    }

    /* äºŒç»´ç å®¹å™¨ */
    .qr-container {
      width: 160px; height: 160px;
      background: #FFF; /* äºŒç»´ç æ°¸è¿œæ˜¯ç™½åº• */
      border-radius: 16px;
      padding: 8px; /* ç•™ä¸€ç‚¹ç™½è¾¹ */
      margin: 0 auto 28px auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .qr-container img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; }

    /* éªŒè¯ç åŒºåŸŸï¼šä»¿ iOS è¾“å…¥æ¡† */
    .code-box {
      background: var(--box-bg);
      border-radius: 12px;
      padding: 16px 0;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }

    .code-text {
      font-size: 38px;
      font-weight: 700; /* ç²—ä½“ï¼Œéè¡¬çº¿ */
      letter-spacing: 12px; /* è¿™ç§é—´è·çœ‹èµ·æ¥æ›´åƒ 4 ä¸ªç‹¬ç«‹çš„æ•°å­— */
      color: var(--text-primary);
      display: inline-block;
      font-variant-numeric: tabular-nums; /* ç­‰å®½æ•°å­—ï¼Œé˜²æ­¢å€’è®¡æ—¶è·³åŠ¨ */
      line-height: 1;
      margin-left: 12px; /* ä¿®æ­£ letter-spacing å¸¦æ¥çš„è§†è§‰åç§» */
    }

    /* æç»†è¿›åº¦æ¡ */
    .progress-line {
      position: absolute;
      bottom: 0; left: 0;
      height: 3px;
      background: var(--accent);
      width: 100%;
      transform-origin: left;
      animation: countdown 60s linear forwards;
      opacity: 0.8;
      border-radius: 0 2px 2px 0;
    }
    @keyframes countdown { from { transform: scaleX(1); } to { transform: scaleX(0); } }

    /* çŠ¶æ€æŒ‡ç¤º */
    .footer-status {
      display: flex; align-items: center; justify-content: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* è‹¹æœé£æ ¼çš„ Loading èŠèŠ± (CSSæ¨¡æ‹Ÿ) */
    .ios-spinner {
      width: 16px; height: 16px;
      position: relative;
      display: inline-block;
    }
    .ios-spinner div {
      transform-origin: 8px 8px;
      animation: ios-spin 1.2s linear infinite;
    }
    .ios-spinner div:after {
      content: " ";
      display: block;
      position: absolute;
      top: 0px; left: 7px;
      width: 2px; height: 4px;
      border-radius: 20%;
      background: var(--text-secondary);
    }
    .ios-spinner div:nth-child(1) { transform: rotate(0deg); animation-delay: -1.1s; }
    .ios-spinner div:nth-child(2) { transform: rotate(30deg); animation-delay: -1.0s; }
    .ios-spinner div:nth-child(3) { transform: rotate(60deg); animation-delay: -0.9s; }
    .ios-spinner div:nth-child(4) { transform: rotate(90deg); animation-delay: -0.8s; }
    .ios-spinner div:nth-child(5) { transform: rotate(120deg); animation-delay: -0.7s; }
    .ios-spinner div:nth-child(6) { transform: rotate(150deg); animation-delay: -0.6s; }
    .ios-spinner div:nth-child(7) { transform: rotate(180deg); animation-delay: -0.5s; }
    .ios-spinner div:nth-child(8) { transform: rotate(210deg); animation-delay: -0.4s; }
    .ios-spinner div:nth-child(9) { transform: rotate(240deg); animation-delay: -0.3s; }
    .ios-spinner div:nth-child(10) { transform: rotate(270deg); animation-delay: -0.2s; }
    .ios-spinner div:nth-child(11) { transform: rotate(300deg); animation-delay: -0.1s; }
    .ios-spinner div:nth-child(12) { transform: rotate(330deg); animation-delay: 0s; }
    @keyframes ios-spin { 0% { opacity: 1; } 100% { opacity: 0; } }

    /* æˆåŠŸçŠ¶æ€ */
    .success-icon-wrapper {
      width: 60px; height: 60px;
      background: var(--box-bg);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 20px auto;
      color: #34C759; /* iOS Green */
      font-size: 30px;
    }

  </style>
</head>
<body>

  <div id="lockPage" class="container">
    <div class="ios-card">
      <h1>è®¿é—®å—é™</h1>
      <p>è¯·æ‰«æä¸‹æ–¹äºŒç»´ç è¾“å…¥éªŒè¯ç </p>
      
      <div class="qr-container">
        <img src="https://img14.360buyimg.com/ling/jfs/t1/357137/38/17178/6526/6926bbc1F2518fce2/9326a50442957ff5.jpg" alt="QR">
      </div>

      <div class="code-box">
        <span id="code" class="code-text">....</span>
        <div id="progressBar" class="progress-line"></div>
      </div>
      
      <div class="footer-status">
        <div class="ios-spinner"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
        <span>ç­‰å¾…éªŒè¯...</span>
      </div>
    </div>
  </div>

  <div id="unlockPage" class="container hidden">
    <div class="ios-card">
      <div class="success-icon-wrapper">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
      </div>
      <h1>éªŒè¯é€šè¿‡</h1>
      <p style="margin-bottom: 0;">æ­£åœ¨è·³è½¬ç›®æ ‡é¡µé¢</p>
    </div>
  </div>

  <script>
    const API_BASE = '/api/web';  
    const TARGET_URL = 'https://www.example.com'; 

    let pollInterval;

    (function init() {
      if (checkCachedToken()) {
        unlockAndRedirect();
      } else {
        startLockFlow();
      }
    })();

    function startLockFlow() {
      const code = Math.floor(Math.random() * 9000) + 1000;
      document.getElementById('code').innerText = code;
      fetch(`${API_BASE}?type=init&code=${code}`).catch(console.error);

      // UIå€’è®¡æ—¶é€»è¾‘
      setTimeout(() => {
        clearInterval(pollInterval);
        alert('éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°');
        location.reload();
      }, 60000);

      pollInterval = setInterval(async () => {
        try {
          const res = await fetch(`${API_BASE}?type=check&code=${code}`);
          const json = await res.json();
          if (json.status === 'success') handleSuccess(json.token);
        } catch(e) {}
      }, 3000);
    }

    function handleSuccess(token) {
      clearInterval(pollInterval);
      localStorage.setItem('unlock_token', token);
      localStorage.setItem('token_time', Date.now());
      
      document.getElementById('lockPage').classList.add('hidden');
      document.getElementById('unlockPage').classList.remove('hidden');
      
      setTimeout(() => { window.location.href = TARGET_URL; }, 1500);
    }

    function checkCachedToken() {
      const token = localStorage.getItem('unlock_token');
      const time = localStorage.getItem('token_time');
      return (token && time && (Date.now() - time < 604800000));
    }

    function unlockAndRedirect() {
      document.getElementById('lockPage').classList.add('hidden');
      window.location.href = TARGET_URL;
    }
  </script>
</body>
</html>
