<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èµ„æºå®‰å…¨éªŒè¯</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    /* è¿›åœºåŠ¨ç”» */
    .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex items-center justify-center p-4 font-sans">

  <div class="bg-white w-full max-w-md rounded-3xl shadow-xl overflow-hidden border border-gray-100 fade-in relative">
    
    <div id="step-verify" class="p-8 text-center">
      <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6">
        <i class="ph-fill ph-lock-key text-3xl"></i>
      </div>
      
      <h2 class="text-2xl font-bold mb-2">è®¿é—®å—é™</h2>
      <p class="text-gray-500 text-sm mb-8 leading-relaxed">
        æœ¬èµ„æºä»…é™ç²‰ä¸è®¿é—®ã€‚<br>
        è¯·å…³æ³¨å…¬ä¼—å·ï¼Œå‘é€ä¸‹æ–¹æ•°å­—å³å¯è‡ªåŠ¨è§£é”ã€‚
      </p>

      <div class="bg-gray-50 border-2 border-dashed border-gray-200 rounded-2xl p-6 mb-6 relative group">
        <div id="code-display" class="text-5xl font-mono font-bold tracking-widest text-gray-800">----</div>
        
        <div class="absolute top-2 right-3 text-xs font-medium text-gray-400">
          <span id="timer">120</span>s åè¿‡æœŸ
        </div>
      </div>

      <div class="flex items-center justify-center gap-2 text-sm text-blue-600 font-medium bg-blue-50/50 py-3 rounded-xl">
        <i class="ph-bold ph-spinner animate-spin"></i>
        <span>ç­‰å¾…æ‰‹æœºç¡®è®¤ä¸­...</span>
      </div>
    </div>

    <div id="step-timeout" class="hidden p-10 text-center">
      <div class="w-16 h-16 bg-gray-100 text-gray-400 rounded-2xl flex items-center justify-center mx-auto mb-6">
        <i class="ph-fill ph-clock-counter-clockwise text-3xl"></i>
      </div>
      <h2 class="text-xl font-bold mb-2 text-gray-700">éªŒè¯ç å·²è¿‡æœŸ</h2>
      <p class="text-gray-500 text-sm mb-8">ä¸ºäº†å®‰å…¨èµ·è§ï¼ŒéªŒè¯ç æœ‰æ•ˆæœŸä¸º 2 åˆ†é’Ÿã€‚</p>
      <button onclick="location.reload()" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-xl transition-all active:scale-95">
        åˆ·æ–°é¡µé¢
      </button>
    </div>

    <div id="step-success" class="hidden bg-green-50 p-10 text-center h-full absolute inset-0 flex flex-col justify-center items-center">
      <div class="w-20 h-20 bg-white text-green-500 rounded-full flex items-center justify-center shadow-sm mb-6">
        <i class="ph-fill ph-check-circle text-5xl"></i>
      </div>
      <h2 class="text-2xl font-bold mb-2 text-green-800">éªŒè¯é€šè¿‡</h2>
      <p class="text-green-600/80 mb-8">æ­£åœ¨è·³è½¬è‡³èµ„æº...</p>
      </div>

  </div>

  <script>
    // --- âš™ï¸ é…ç½®åŒºåŸŸ (å¼€æºæ—¶æ”¹è¿™é‡Œå³å¯) ---
    const CONFIG = {
      apiBase: '/api/web', // åç«¯ API åœ°å€
      pollInterval: 5000,  // è½®è¯¢é—´éš” (5ç§’)
      timeout: 120,        // è¶…æ—¶æ—¶é—´ (120ç§’)
    };

    // --- ğŸš€ æ ¸å¿ƒé€»è¾‘ ---
    
    // 1. ç”Ÿæˆ 4 ä½éšæœºæ•° (1000-9999)
    const code = Math.floor(1000 + Math.random() * 9000);
    document.getElementById('code-display').innerText = code;

    let timeLeft = CONFIG.timeout;
    let timerInterval;
    let pollInterval;

    // å¯åŠ¨å€’è®¡æ—¶
    function startTimer() {
      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').innerText = timeLeft;
        
        if (timeLeft <= 0) {
          handleTimeout();
        }
      }, 1000);
    }

    // å¯åŠ¨è½®è¯¢
    function startPolling() {
      pollInterval = setInterval(async () => {
        try {
          const res = await fetch(`${CONFIG.apiBase}?type=check&code=${code}`);
          const json = await res.json();

          if (json.status === 'success') {
            handleSuccess(json.token);
          }
        } catch (e) {
          console.error('Polling error', e);
        }
      }, CONFIG.pollInterval);
    }

    // å¤„ç†è¶…æ—¶
    function handleTimeout() {
      clearInterval(timerInterval);
      clearInterval(pollInterval);
      document.getElementById('step-verify').classList.add('hidden');
      document.getElementById('step-timeout').classList.remove('hidden');
    }

    // å¤„ç†æˆåŠŸ
    function handleSuccess(token) {
      clearInterval(timerInterval);
      clearInterval(pollInterval);
      
      // ä¿å­˜ Token
      localStorage.setItem('access_token', token);

      // åˆ‡æ¢ UI
      document.getElementById('step-verify').classList.add('hidden');
      document.getElementById('step-success').classList.remove('hidden');

      // æ¨¡æ‹Ÿè·³è½¬ (å®é™…ä½¿ç”¨æ—¶æ›¿æ¢ä¸ºä½ çœŸæ­£çš„å†…å®¹é¡µ URL)
      console.log('æ‹¿åˆ° Token:', token);
      // setTimeout(() => window.location.href = '/real-content', 1500);
    }

    // åˆå§‹åŒ–
    startTimer();
    startPolling();

  </script>
</body>
</html>
