<!DOCTYPE html>
<html lang="zh-CN" class="antialiased">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  
  <title>Movie Hub</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <script>
    tailwind.config = {
      darkMode: 'class', // 强制暗黑模式更有影视感
      theme: {
        extend: {
          colors: {
            dark: { bg: '#000000', card: '#1C1C1E', text: '#F5F5F7', sub: '#98989D', border: 'rgba(255,255,255,0.15)', input: 'rgba(255, 255, 255, 0.1)' }
          },
          fontFamily: { sans: ['SF Pro Display', '-apple-system', 'sans-serif'] },
          animation: { 'enter': 'enter 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards' },
          keyframes: { enter: { '0%': { opacity: '0', transform: 'translateY(20px) scale(0.98)' }, '100%': { opacity: '1', transform: 'translateY(0) scale(1)' } } }
        }
      }
    }
  </script>
  <style>
    body { background-color: #000000; color: #F5F5F7; }
    .active-scale:active { transform: scale(0.96); transition: transform 0.1s; }
    /* 隐藏滚动条 */
    ::-webkit-scrollbar { display: none; }
  </style>
</head>

<body class="font-sans min-h-screen flex flex-col pb-safe">

  <nav class="sticky top-0 z-50 bg-[#1C1C1E]/80 backdrop-blur-xl border-b border-dark-border px-6 py-4 pt-[max(1rem,env(safe-area-inset-top))] flex justify-between items-center">
    <div class="flex items-center gap-2 font-bold text-lg tracking-tight">
      <i class="ph-fill ph-film-strip text-purple-500 text-xl"></i>
      <span>Movie Hub</span>
    </div>
    <div id="lockStatus" class="text-xs font-medium bg-white/10 px-3 py-1 rounded-full text-dark-sub flex items-center gap-1">
      <i class="ph-fill ph-lock-key"></i> 未解锁
    </div>
  </nav>

  <main class="flex-1 max-w-4xl mx-auto w-full px-6 py-8 opacity-0 animate-enter">
    
    <header class="mb-10">
      <h1 class="text-4xl md:text-5xl font-bold tracking-tight leading-tight">
        全网影视，<br>
        <span class="text-dark-sub mt-2 block">一键聚合搜索。</span>
      </h1>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
      
      <div class="md:col-span-2 bg-dark-card rounded-[2rem] p-8 border border-dark-border shadow-2xl shadow-purple-900/10 relative overflow-hidden flex flex-col justify-between min-h-[320px]">
        <div>
          <div class="flex items-center gap-3 mb-6">
            <div class="w-12 h-12 bg-purple-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-purple-600/20">
              <i class="ph-bold ph-magnifying-glass text-2xl"></i>
            </div>
            <h2 class="text-2xl font-semibold">聚合搜索</h2>
          </div>
          <p class="text-dark-sub text-base leading-relaxed">
            输入电影/剧集名称，自动检索全网公开分享的<br>阿里云盘、夸克网盘资源。
          </p>
        </div>

        <div class="mt-auto relative group">
          <i class="ph-bold ph-film-slate absolute left-4 top-1/2 -translate-y-1/2 text-dark-sub text-lg"></i>
          <input type="text" id="searchInput" 
            class="w-full bg-dark-input text-lg py-4 pl-12 pr-4 rounded-2xl outline-none focus:ring-2 focus:ring-purple-500/50 transition-all placeholder-white/30 text-white"
            placeholder="例如: 星际穿越" 
            onkeypress="if(event.keyCode===13) handleSearch('quark')">
        </div>

        <button onclick="handleSearch('quark')" class="mt-4 w-full bg-white text-black font-bold py-4 rounded-2xl flex items-center justify-center gap-2 active-scale transition-colors hover:bg-gray-100">
          <span>搜索夸克网盘</span>
          <i class="ph-bold ph-arrow-up-right"></i>
        </button>
      </div>

      <div class="grid grid-cols-1 gap-5">
        
        <div onclick="handleSearch('aliyun')" class="bg-dark-card rounded-[2rem] p-6 border border-dark-border shadow-sm cursor-pointer active-scale flex flex-col justify-between h-40 relative group hover:border-blue-500/50 transition-all">
          <div class="flex justify-between items-start">
            <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center text-blue-400">
              <i class="ph-fill ph-cloud text-xl"></i>
            </div>
            <i class="ph-bold ph-caret-right text-dark-sub"></i>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-blue-100">阿里云盘</h3>
            <p class="text-sm text-dark-sub mt-1">搜索 Aliyun Drive</p>
          </div>
        </div>

        <div onclick="handleSearch('douban')" class="bg-dark-card rounded-[2rem] p-6 border border-dark-border shadow-sm cursor-pointer active-scale flex flex-col justify-between h-40 relative group hover:border-green-500/50 transition-all">
          <div class="flex justify-between items-start">
            <div class="w-10 h-10 bg-green-500/20 rounded-xl flex items-center justify-center text-green-400">
              <i class="ph-fill ph-star text-xl"></i>
            </div>
            <i class="ph-bold ph-caret-right text-dark-sub"></i>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-green-100">豆瓣评分</h3>
            <p class="text-sm text-dark-sub mt-1">查看影评 & 简介</p>
          </div>
        </div>

      </div>
    </div>

    <footer class="mt-16 pt-8 border-t border-dark-border flex flex-col items-center gap-4 text-xs text-dark-sub">
      <div class="flex items-center gap-2 opacity-80"><i class="ph-fill ph-film-strip text-base"></i><span class="font-semibold">Movie Hub</span></div>
      <p>仅供技术交流，请勿用于非法用途。</p>
    </footer>

  </main>

  <div id="lockScreen" class="fixed inset-0 z-[999] bg-black/90 backdrop-blur-md flex flex-col items-center justify-center p-6 transition-all duration-500 hidden">
    <div class="bg-[#1C1C1E] p-8 rounded-[2rem] shadow-2xl max-w-sm w-full text-center border border-white/10">
      <i class="ph-fill ph-lock-key text-5xl text-purple-500 mb-4"></i>
      <h2 class="text-2xl font-bold mb-2 text-white">访问受限</h2>
      <p class="text-gray-400 text-sm mb-6">
        请关注公众号，发送下方数字解锁<br>
        <span class="text-xs opacity-50">(这是为了防止机器人滥用)</span>
      </p>
      
      <div class="bg-black/30 border border-white/10 rounded-2xl p-6 mb-6">
        <div id="code-display" class="text-5xl font-mono font-bold tracking-widest text-white">----</div>
      </div>

      <div class="flex items-center justify-center gap-2 text-sm text-purple-400 font-medium">
        <i class="ph-bold ph-spinner animate-spin"></i>
        <span>等待手机确认...</span>
      </div>
    </div>
  </div>

  <script>
    // --- 配置 ---
    const CONFIG = {
      apiBase: '/api/web', 
      pollInterval: 5000, 
      timeout: 120,
    };

    let isUnlocked = false;

    // --- 核心搜索逻辑 (Google Dorks) ---
    function handleSearch(type) {
      // 1. 先检查锁
      if (!isUnlocked) {
        // 如果没解锁，弹出锁屏，并开始验证流程
        startAuthFlow(); 
        return;
      }

      const q = document.getElementById('searchInput').value.trim();
      if (!q) {
        document.getElementById('searchInput').focus();
        return;
      }

      let url = '';
      // 这里的 site: 语法是核心，它利用 Google 搜索特定网盘的公开链接
      switch (type) {
        case 'quark':
          url = `https://www.google.com/search?q=${encodeURIComponent(q)} site:pan.quark.cn`;
          break;
        case 'aliyun':
          url = `https://www.google.com/search?q=${encodeURIComponent(q)} site:aliyundrive.com`;
          break;
        case 'douban':
          url = `https://www.douban.com/search?q=${encodeURIComponent(q)}`;
          break;
      }

      // 打开新标签页
      window.open(url, '_blank');
    }

    // --- 验证逻辑 (复用之前的) ---
    // 检查本地缓存
    function checkCachedToken() {
      const token = localStorage.getItem('access_token');
      // 这里简单判断有 Token 就行，实际可以加时间校验
      if (token) {
        isUnlocked = true;
        updateUIUnlocked();
        return true;
      }
      return false;
    }

    function updateUIUnlocked() {
      const tag = document.getElementById('lockStatus');
      tag.className = "text-xs font-medium bg-green-500/20 text-green-400 px-3 py-1 rounded-full flex items-center gap-1";
      tag.innerHTML = '<i class="ph-fill ph-check-circle"></i> 已解锁';
    }

    // 启动验证流程
    function startAuthFlow() {
      const lockScreen = document.getElementById('lockScreen');
      lockScreen.classList.remove('hidden');
      
      // 生成随机码
      const code = Math.floor(1000 + Math.random() * 9000);
      document.getElementById('code-display').innerText = code;

      // 发送 init (请确保你的后端 web.js 和 wechat.js 已经部署好)
      fetch(`${CONFIG.apiBase}?type=init&code=${code}`).catch(e => console.error(e));

      // 开始轮询
      let interval = setInterval(async () => {
        try {
          const res = await fetch(`${CONFIG.apiBase}?type=check&code=${code}`);
          const json = await res.json();
          if (json.status === 'success') {
            clearInterval(interval);
            
            // 成功！
            localStorage.setItem('access_token', json.token);
            isUnlocked = true;
            updateUIUnlocked();
            
            // 关闭弹窗
            lockScreen.classList.add('hidden');
            
            // 自动触发刚才点击的搜索 (可选)
            // alert('解锁成功，请再次点击搜索');
          }
        } catch (e) {}
      }, CONFIG.pollInterval);
    }

    // 页面加载时检查
    checkCachedToken();

  </script>
</body>
</html>
