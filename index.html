<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>全自动验证演示</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    @keyframes pulse-ring {
      0% { transform: scale(0.8); opacity: 0.5; }
      100% { transform: scale(1.3); opacity: 0; }
    }
    .ring-anim {
      position: absolute;
      border-radius: 50%;
      border: 2px solid #3b82f6;
      width: 100%; height: 100%;
      animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
    }
  </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen text-gray-800">

  <div id="lockScreen" class="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-sm w-full border border-gray-100 relative overflow-hidden transition-all duration-500">
    
    <div class="mb-6 relative inline-block">
      <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 relative z-10">
        <i class="ph-fill ph-lock-key text-4xl"></i>
      </div>
      <div class="ring-anim top-0 left-0"></div>
    </div>

    <h1 class="text-2xl font-bold mb-2">安全验证</h1>
    <p class="text-gray-500 text-sm mb-8">请关注公众号，发送下方数字</p>

    <div class="bg-gray-100 rounded-2xl p-6 mb-6">
      <div id="codeDisplay" class="text-5xl font-mono font-bold tracking-widest text-gray-800">----</div>
    </div>

    <div class="flex items-center justify-center gap-2 text-xs text-gray-400 font-medium">
      <i class="ph-bold ph-spinner animate-spin"></i>
      <span>正在等待手机确认...</span>
    </div>
  </div>

  <div id="successScreen" class="hidden bg-green-500 p-10 rounded-3xl shadow-2xl text-center max-w-sm w-full text-white transition-all duration-500 transform scale-95 opacity-0">
    <div class="mb-6 w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto">
      <i class="ph-bold ph-check text-4xl"></i>
    </div>
    <h1 class="text-3xl font-bold mb-4">验证通过</h1>
    <p class="text-green-100 mb-8">网页已自动解锁，欢迎回来。</p>
    <button class="bg-white text-green-600 px-8 py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">
      进入系统
    </button>
  </div>

  <script>
    // 1. 生成随机 4 位数 (1000-9999)
    const challengeCode = Math.floor(1000 + Math.random() * 9000);
    document.getElementById('codeDisplay').innerText = challengeCode;

    // 2. 开始轮询 (每 2 秒问一次后端)
    let pollInterval = setInterval(async () => {
      try {
        // 请求后端检查
        const res = await fetch(`/api/web?type=check_login&code=${challengeCode}`);
        const json = await res.json();

        if (json.status === 'success') {
          // ✅ 成功！
          clearInterval(pollInterval); // 停止轮询
          showSuccess();
        }
      } catch (e) {
        console.error('Polling error', e);
      }
    }, 2000);

    // 切换到成功界面
    function showSuccess() {
      const lock = document.getElementById('lockScreen');
      const success = document.getElementById('successScreen');

      // 简单的淡出淡入动画
      lock.style.opacity = '0';
      lock.style.transform = 'scale(0.95)';
      
      setTimeout(() => {
        lock.style.display = 'none';
        success.classList.remove('hidden');
        // 强制重绘以触发 transition
        requestAnimationFrame(() => {
          success.style.opacity = '1';
          success.style.transform = 'scale(1)';
        });
      }, 300);
    }
  </script>

</body>
</html>
