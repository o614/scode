<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®¿é—®å—é™</title>
  <style>
    :root { --bg: #0a0a0a; --card: #1c1c1e; --text: #f5f5f7; --accent: #8b5cf6; }
    body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    
    /* å®¹å™¨ */
    .container { text-align: center; width: 100%; max-width: 360px; padding: 20px; }
    
    /* é”å®šå¡ç‰‡ */
    .lock-card { background: var(--card); border-radius: 24px; padding: 40px 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); transition: transform 0.3s ease, opacity 0.3s ease; }
    .hidden { display: none !important; opacity: 0; }
    
    /* å›¾æ ‡ä¸æ–‡å­— */
    .icon-lock { font-size: 48px; margin-bottom: 20px; display: block; }
    h1 { font-size: 20px; margin: 0 0 10px 0; font-weight: 600; }
    p { font-size: 14px; color: #888; margin: 0 0 30px 0; line-height: 1.5; }
    
    /* äºŒç»´ç å›¾ç‰‡å®¹å™¨ */
    .qr-box { width: 180px; height: 180px; background: #fff; padding: 10px; border-radius: 12px; margin: 0 auto 30px auto; }
    .qr-box img { width: 100%; height: 100%; object-fit: cover; }

    /* éªŒè¯ç æ˜¾ç¤º */
    .code-display { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; position: relative; overflow: hidden; }
    .code-number { font-family: monospace; font-size: 32px; letter-spacing: 8px; font-weight: bold; color: var(--text); display: block; }
    .timer { font-size: 10px; color: #666; position: absolute; top: 5px; right: 8px; }
    
    /* åŠ è½½åŠ¨ç”» */
    .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: var(--text); animation: spin 1s ease-in-out infinite; margin-right: 8px; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* è§£é”æˆåŠŸçŠ¶æ€ */
    .success-view { color: #4ade80; }
    .btn { display: inline-block; background: var(--text); color: #000; padding: 12px 30px; border-radius: 50px; text-decoration: none; font-weight: bold; margin-top: 20px; transition: opacity 0.2s; }
    .btn:active { opacity: 0.8; }
  </style>
</head>
<body>

  <div id="lockPage" class="container">
    <div class="lock-card">
      <span class="icon-lock">ğŸ”’</span>
      <h1>ç½‘é¡µå·²åŠ å¯†</h1>
      <p>è¯·æ‰«æä¸‹æ–¹äºŒç»´ç å…³æ³¨å…¬ä¼—å·<br>å‘é€éªŒè¯ç è·å–è®¿é—®æƒé™</p>
      
      <div class="qr-box">
        <img src="https://www.haiyan.gov.cn/picture/-1/240308141912543626.png" alt="QR Code">
      </div>

      <div class="code-display">
        <div id="timer" class="timer">60s</div>
        <span id="code" class="code-number">....</span>
      </div>
      
      <div style="margin-top: 20px; font-size: 12px; color: #555;">
        <span class="spinner"></span> ç­‰å¾…éªŒè¯ä¸­...
      </div>
    </div>
  </div>

  <div id="unlockPage" class="container hidden">
    <div class="lock-card">
      <span class="icon-lock">ğŸ”“</span>
      <h1>éªŒè¯æˆåŠŸ</h1>
      <p>æ­£åœ¨å‰å¾€ç›®æ ‡é¡µé¢...</p>
      <div class="spinner" style="border-top-color: #4ade80;"></div>
    </div>
  </div>

  <script>
    // ================= é…ç½®åŒºåŸŸ =================
    const API_BASE = '/api/web';  // åç«¯æ¥å£åœ°å€
    const TARGET_URL = 'https://www.google.com'; // ğŸ”“ è§£é”åè·³è½¬çš„ç›®æ ‡ç½‘å€ (è¯·ä¿®æ”¹è¿™é‡Œ)
    // ===========================================

    let timerInterval, pollInterval;

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
    (function init() {
      if (checkCachedToken()) {
        unlockAndRedirect();
      } else {
        startLockFlow();
      }
    })();

    function startLockFlow() {
      // 1. ç”Ÿæˆ 4 ä½éšæœºæ•°å­— (1000-9999)
      const code = Math.floor(Math.random() * 9000) + 1000;
      document.getElementById('code').innerText = code;

      // 2. å‘Šè¯‰åç«¯åˆå§‹åŒ–è¿™ä¸ª code
      fetch(`${API_BASE}?type=init&code=${code}`).catch(console.error);

      // 3. å€’è®¡æ—¶é€»è¾‘ (60ç§’)
      let timeLeft = 60;
      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').innerText = timeLeft + 's';
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          clearInterval(pollInterval);
          alert('éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
          location.reload();
        }
      }, 1000);

      // 4. è½®è¯¢æŸ¥çŠ¶æ€ (æ¯ 3 ç§’æŸ¥ä¸€æ¬¡)
      pollInterval = setInterval(async () => {
        try {
          const res = await fetch(`${API_BASE}?type=check&code=${code}`);
          const json = await res.json();
          if (json.status === 'success') {
            handleSuccess(json.token);
          }
        } catch(e) { console.error(e); }
      }, 3000);
    }

    function handleSuccess(token) {
      clearInterval(timerInterval);
      clearInterval(pollInterval);
      
      // ç¼“å­˜ Token (é»˜è®¤æœ‰æ•ˆæœŸ7å¤©)
      localStorage.setItem('unlock_token', token);
      localStorage.setItem('token_time', Date.now());

      // åˆ‡æ¢ç•Œé¢
      document.getElementById('lockPage').classList.add('hidden');
      document.getElementById('unlockPage').classList.remove('hidden');

      // 1.5ç§’åè·³è½¬
      setTimeout(() => {
        window.location.href = TARGET_URL;
      }, 1500);
    }

    // æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰æœ‰æ•ˆ Token
    function checkCachedToken() {
      const token = localStorage.getItem('unlock_token');
      const time = localStorage.getItem('token_time');
      // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸”æœªè¿‡æœŸ (7å¤© = 604800000 æ¯«ç§’)
      if (token && time && (Date.now() - time < 604800000)) { 
        return true; 
      }
      return false;
    }

    // ç›´æ¥è·³è½¬
    function unlockAndRedirect() {
      document.getElementById('lockPage').classList.add('hidden');
      // å¯ä»¥ç›´æ¥è·³è½¬ï¼Œä¸æ˜¾ç¤ºä¸­é—´é¡µï¼Œä¹Ÿå¯ä»¥æ˜¾ç¤ºä¸€ä¸‹ "Welcome Back"
      window.location.href = TARGET_URL;
    }
  </script>
</body>
</html>
